{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "name": {
            "type": "string",
            "metadata": {
                "description": "Name of the App Service Environment"
            }
        },
        "certificateName":{
           "type":"string",
           "metadata":{
              "description":"User friendly certificate resource name"
           }
        },
        "hostname":{
           "type":"string",
           "metadata":{
              "description":"Custom hostname for creating SSL binding. This hostname should already be assigned to the Web App"
           }
        },
        "sslVaultSecretName":{
           "type":"string",
           "metadata":{
              "description":"Key Vault Secret that contains a PFX certificate"
           }
         },
         "key_vault_uri":{
            "type":"string",
            "metadata":{
               "description":"Existing Key Vault URI"
            }
         },
         "key_vault_id":{
            "type":"string",
            "metadata":{
               "description":"Existing Key Vault resource Id with an access policy to allow Microsoft.Web RP to read Key Vault secrets (Checkout README.md for more information)"
            }
         },
        "location": {
            "type": "string",
            "allowedValues": [
                "UK South"
            ],
            "metadata": {
                "description": "Location of the App Service Environment"
            }
         },
        "aseAppServiceWorkerPool": {
          "type": "string",
          "allowedValues": [
            "1",
            "2",
            "3"
          ],
          "defaultValue": "1",
          "metadata": {
            "description": "Defines which worker pool's (WP1, WP2 or WP3) resources will be used for the app service plan."
          }
        },
        "aseAppServiceNumberOfWorkers": {
          "type": "int",
          "defaultValue": 1,
          "metadata": {
            "description": "Defines the number of workers from the worker pool that will be used by the app service plan."
          }
        },
        "env": {
            "type": "string",
            "metadata": {
                "description": "The tag"
            }
        },
        "app_settings": {
          "type": "string"
        },
        "dependancy": {
          "type": "string"
        }
    },
    "variables": {
        "base64AppSettingObject": "[base64(parameters('app_settings'))]",
        "config_web_name": "[concat(parameters('name'),'/web')]"
    },
    "resources": [
      {
          "name": "[parameters('name')]",
          "type": "Microsoft.Web/serverfarms",
          "location": "[parameters('location')]",
          "apiVersion": "2016-09-01",
          "tags": {
            "displayName": "Application Service Plan",
            "environment": "[parameters('env')]"
          },
          "properties": {
            "name": "[parameters('name')]",
            "hostingEnvironment": "[concat('app-compute-', parameters('env'))]",
            "hostingEnvironmentId": "[resourceId('Microsoft.Web/hostingEnvironments', concat('app-compute-', parameters('env')))]"
          },
          "sku": {
            "name": "I2",
            "tier": "Isolated",
            "size": "I2",
            "family": "I",
            "capacity": 2
        }
      },
      {
         "type":"Microsoft.Web/certificates",
         "name":"[parameters('certificateName')]",
         "apiVersion":"2016-03-01",
         "location":"[parameters('location')]",
         "properties":{
            "keyVaultId":"[parameters('key_vault_id')]",
            "keyVaultSecretName":"[parameters('sslVaultSecretName')]",
            "serverFarmId":"[resourceId('Microsoft.Web/serverfarms/', concat('app-compute-', parameters('env')))]"
         }
      },
      {
        "name": "[parameters('name')]",
        "type": "Microsoft.Web/sites",
        "location": "[parameters('location')]",
        "apiVersion": "2016-08-01",
        "dependsOn": [
          "[resourceId('Microsoft.Web/serverfarms', parameters('name'))]"
        ],
        "tags": {
          "[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', parameters('name')))]": "Resource",
          "displayName": "ASE-WEB-APP",
          "environment": "[parameters('env')]"
        },
        "properties": {
          "name": "[parameters('name')]",
          "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', parameters('name'))]",
          "hostingEnvironment": "[concat('app-compute-', parameters('env'))]",
          "hostingEnvironmentId": "[resourceId('Microsoft.Web/hostingEnvironments', concat('app-compute-', parameters('env')))]",
          "scmType": "LocalGit",
          "httpLoggingEnabled": true,
          "logsDirectorySizeLimit": 35,
          "detailedErrorLoggingEnabled": true,
          "use32BitWorkerProcess": false,
          "hostNameSslStates":[
            {
              "name":"[parameters('hostname')]",
              "sslState":"SniEnabled",
              "thumbprint":"[reference(resourceId('Microsoft.Web/certificates', parameters('certificateName'))).Thumbprint]",
              "toUpdate":true
            }
          ]
        },
        "resources": [
          {
            "apiVersion": "2014-11-01",
            "name": "appsettings",
            "type": "config",
            "dependsOn": [
              "[resourceId('Microsoft.Web/sites', parameters('name'))]"
            ],
            "properties": "[base64ToJson(variables('base64AppSettingObject'))]"
          },
          {
            "name": "[parameters('name')]",
            "type": "hostNameBindings",
            "apiVersion": "2016-08-01",
            "location": "[parameters('location')]",
            "tags": {},
            "properties": {
              "siteName": "[parameters('hostname')]",
              "domainId": null,
              "hostNameType": "Verified"
            },
            "dependsOn": [
                  "[resourceId('Microsoft.Web/sites', parameters('name'))]",
                  "[resourceId('Microsoft.Web/certificates', parameters('certificateName'))]"
              ]
            }
          ]
      },
      {
        "type": "Microsoft.Web/sites/config",
        "name": "[variables('config_web_name')]",
        "apiVersion": "2016-08-01",
        "location": "[parameters('location')]",
        "scale": null,
        "properties": {
            "defaultDocuments": [
                "Default.htm",
                "Default.html",
                "Default.asp",
                "index.htm",
                "index.html",
                "iisstart.htm",
                "default.aspx",
                "index.php",
                "hostingstart.html"
            ],
            "netFrameworkVersion": "v4.0",
            "phpVersion": "5.6",
            "pythonVersion": "",
            "nodeVersion": "",
            "linuxFxVersion": "",
            "requestTracingEnabled": false,
            "remoteDebuggingEnabled": false,
            "remoteDebuggingVersion": "VS2012",
            "httpLoggingEnabled": false,
            "logsDirectorySizeLimit": 35,
            "detailedErrorLoggingEnabled": false,
            "publishingUsername": "$probate-frontend-dev",
            "publishingPassword": null,
            "appSettings": null,
            "metadata": null,
            "connectionStrings": null,
            "machineKey": null,
            "handlerMappings": null,
            "documentRoot": null,
            "scmType": "None",
            "use32BitWorkerProcess": true,
            "webSocketsEnabled": false,
            "alwaysOn": true,
            "javaVersion": "1.8",
            "javaContainer": "TOMCAT",
            "javaContainerVersion": "8.0",
            "appCommandLine": "",
            "managedPipelineMode": "Integrated",
            "virtualApplications": [
                {
                    "virtualPath": "/",
                    "physicalPath": "site\\wwwroot",
                    "preloadEnabled": true,
                    "virtualDirectories": null
                }
            ],
            "winAuthAdminState": 0,
            "winAuthTenantState": 0,
            "customAppPoolIdentityAdminState": false,
            "customAppPoolIdentityTenantState": false,
            "runtimeADUser": null,
            "runtimeADUserPassword": null,
            "loadBalancing": "LeastRequests",
            "routingRules": [],
            "experiments": {
                "rampUpRules": []
            },
            "limits": null,
            "autoHealEnabled": false,
            "autoHealRules": {
                "triggers": null,
                "actions": null
            },
            "tracingOptions": null,
            "vnetName": "",
            "siteAuthEnabled": false,
            "siteAuthSettings": {
                "enabled": null,
                "unauthenticatedClientAction": null,
                "tokenStoreEnabled": null,
                "allowedExternalRedirectUrls": null,
                "defaultProvider": null,
                "clientId": null,
                "clientSecret": null,
                "issuer": null,
                "allowedAudiences": null,
                "additionalLoginParams": null,
                "isAadAutoProvisioned": false,
                "googleClientId": null,
                "googleClientSecret": null,
                "googleOAuthScopes": null,
                "facebookAppId": null,
                "facebookAppSecret": null,
                "facebookOAuthScopes": null,
                "twitterConsumerKey": null,
                "twitterConsumerSecret": null,
                "microsoftAccountClientId": null,
                "microsoftAccountClientSecret": null,
                "microsoftAccountOAuthScopes": null
            },
            "cors": null,
            "push": null,
            "apiDefinition": null,
            "autoSwapSlotName": null,
            "localMySqlEnabled": false,
            "ipSecurityRestrictions": null
        },
        "dependsOn": [
            "[resourceId('Microsoft.Web/sites', parameters('name'))]"
        ]
      }
    ]
  }
